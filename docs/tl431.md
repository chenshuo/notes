# TL431

Comments and discussions: <https://github.com/chenshuo/notes/discussions>

## Bandgap voltage reference

See "How a bandgap reference works" section in <https://www.righto.com/2014/09/reverse-engineering-counterfeit-7805.html>

The thermal voltage \(V_\mathrm{T} = \dfrac{kT}{q}\) is proportional to absolute temperature (PTAT). \(V_\mathrm{T} \approx 25.8\mathrm{mV}\) at room temperature (27°C, or 300K).

> Ref. <https://en.wikipedia.org/wiki/Boltzmann_constant#The_thermal_voltage>

\(V_\mathrm{T}\) has a positive temperature coefficient of about 86.2μV/°C.

> \(\dfrac{V_\mathrm{T}}{T} = \dfrac{k}{q} = \dfrac{ 1.380649\times 10^{-23}}{1.602176634\times 10^{-19}} \approx 8.62 \times 10^{-5}\mathrm{V/K}\)

Therefore, we usually need \(10\ln 10 \cdot V_\mathrm{T}\approx 23V_\mathrm{T}\) to cancel out the tempco of one \(V_\mathrm{BE}\), which normally has a negative tempco about -2mV/°C.

> \(10 \ln 10 \times 86.2 \approx 23 \times 86.2 = 1.983\mathrm{mV/°C}\)

The actual tempco of \(V_\mathrm{BE}\) is related to \(V_\mathrm{BE}\) itself, see formula in <https://en.wikipedia.org/wiki/Silicon_bandgap_temperature_sensor>

## The internal schematic

![TL431](media/tl431a.png)

Resistors are taken from official TI datasheet <https://www.ti.com/lit/ds/symlink/tl431.pdf>.

The resistor and transistor numbering follows [SPICE model by Eugene Dvoskin](https://www.audio-perfection.com/voltage-regulators/linear-regulators/accurate-tl431-model-development-analysis-and-evaluation/).

Transistor \(Q_{11}\) is drawn in dashed lines, as it is off in normal operation mode.
IIUC, it acts like a diode to shutdown the output when `Ref` is connected to `Anode`.

## Analysis

Ignoring base currents, assuming \(\beta\gg 1\).
As we will see in the next section , we can actually estimate that \(\beta\approx 120\).

For the following analysis, we assume area ratio of \(Q_6:Q_2:Q_3\) being \(1:3:6\), taken from [The TL431 in loop control](https://powersimtof.com/Downloads/Papers/The%20TL431%20in%20loop%20control.pdf) by Christophe Basso.
Eugene Dvoskin's SPICE model (at the end of this page) uses a different ratio (\(0.5:1.2:2.2\)) though.

![TL431](media/tl431b.png)

1. There are 11 transistors in total, \(Q_{11}\) is normally off, so we need to analyze 10 BJTs only.
1. It's easy to see that \(Q_9\) and \(Q_{10}\) form a Darlinton pair, it's the output stage.
1. It's also easy to recognize that \(Q_7\) and \(Q_8\) is a [current mirror](https://en.wikipedia.org/wiki/Current_mirror), if we assuming they have the same area. (In Ken Shirriff's schematic below, their areas are different, though.)
1. The rest of 6 transistors \(Q_1\dots Q_6\) are tangled together, let's analyse them in parts.

## Calculation

**Notation**:

* \(V_\mathrm{BE1}\) denotes the Base-Emitter junction voltage of transistor \(Q_1\)
* \(V_\mathrm{Q2B}\) denotes the base voltage of transistor \(Q_2\).
* \(V_\mathrm{Q3E}\) denotes the emitter voltage of transistor \(Q_3\).
* It's obvious from the schematic above, \(V_\mathrm{Q3C} = V_\mathrm{Q5B}\).
* \(I_\mathrm{B6}\) denotes the base current of transistor \(Q_6\).
* \(V_\mathrm{R3}\) denotes the voltage on resistor \(R_3\).
* \(I_2\), \(I_3\), \(I_4\) are currents on \(R_2\), \(R_3\), \(R_4\), respectively, \(I_4 = I_2 + I_3\) as shown in the full schematic above.
* Ignoring base currents, \(I_2 = I_\mathrm{C2} =  I_\mathrm{E2}\), \(I_3 = I_\mathrm{C3} =  I_\mathrm{E3}\), \(I_4 = I_\mathrm{C1} =  I_\mathrm{E1}\).

**First**, we consider \(Q_1, Q_2, Q_3\) alone. Ignoring base currents.


1. Assuming \(V_\mathrm{BE1}=V_\mathrm{BE2}=V_\mathrm{BE5}\approx 0.65\mathrm{V}\), \(I_2 R_2 = I_3 R_3\), so \(I_2 = \dfrac{R_3}{R_2}I_3 = 3I_3\). The current on \(R_4\) is \(I_4 \approx 4I_3\).
2. Voltage on \(R_3\) and \(R_4\) is \(V_\mathrm{REF} - V_\mathrm{BE1}-V_\mathrm{BE5} = 2.5-2\times 0.65 = 1.2\mathrm{V}\)
3. The total resistance across the aforementioned 1.2V is \(R_4 + R_2/\!/R_3 = 3.2 + 2.4 /\!/ 7.2 = 3.2+1.8 = 5\)kΩ
4. The current on \(R_4\) is \(I_4 =  \dfrac{1.2}{5} = 0.24\)mA, so
\(I_\mathrm{Q1E} = 240\)μA, \(I_3 = 60\)μA, \(I_2 = 3I_3 = 180\)μA.
5. The datasheet says typical \(I_\mathrm{REF}=I_\mathrm{Q1B}=2\)μA, so we estimate \(\beta + 1 = I_{Q1E}/I_\mathrm{Q1B} = 240/2 = 120\).


![TL431](media/tl431dc1.png)

The voltages and currents shown in above schematic are from SPICE simulation.

**Second**, we add \(Q_4\dots Q_8\) into the picture, omitting \(Q_9\) and \(Q_{10}\) for now.

It's safe to assume that all \(Q_4\dots Q_8\) share the same (emitter) current, because \(Q_7\) and \(Q_8\) form a current mirror, and it sets the currents of \(Q_4\), \(Q_5\), and \(Q_6\) to be all the same.

We will show that the current is 60μA for \(Q_4\dots Q_8\), same as emitter current of \(Q_3\).

1. \(V_\mathrm{Q2B} \approx V_\mathrm{Q6B}\), because \(I_\mathrm{B6}\) is less than 1μA, so voltage drop on \(R_6\) is less than 1mV.
2. Area of \(Q_6\) is 1E, area of \(Q_2\) is 3E, with the same base voltage, \(I_\mathrm{E2} = 3 I_\mathrm{E6}\)
3. We already knew that \(I_\mathrm{E2} = I_2 = 3I_3\), so \(I_3 = I_\mathrm{E6} = I_\mathrm{E3} = 60\)μA. In other words, \(Q_6\) has same current as \(Q_3\).
4. Due to current mirror made of \(Q_7\) and \(Q_8\), \(Q_4\) and \(Q_5\) mirrors the current of \(Q_6\). (But, see the note below.)
5. In conclusion, 6 transistors \(Q_3\dots Q_8\) all have the same current as \(Q_3\), when balanced, that is \(I_3=60\)μA.

Although this conclusion matches the simulation of the next section, there is an **unsolved puzzle**: the current mirror of \(Q_7\) and \(Q_8\) is supposed to copy \(Q_7\)'s current to \(Q_8\), but not vice versa.  However, the analysis above assume current of \(Q_6\), \(I_\mathrm{E6}\), is set by \(V_\mathrm{Q2B}\), then mirrored in \(Q_4\) and \(Q_5\).
Is this reasonable? My explaination is that the feedback of output stage will bring the circuit into the balanced state, where \(I_\mathrm{E4} = I_\mathrm{E6}\). (\(I_\mathrm{C6} = I_\mathrm{C8} - I_\mathrm{B9}\))

The following diagram shows what we have analyzed so far.

![TL431](media/tl431dc2.png)

The voltages and currents shown in above schematic are from SPICE simulation.

**Third**, let's calculate the required \(I_\mathrm{S}\), just for fun.

The reference voltage can be divided into 4 segments, from base of \(Q_1\) to ground: \(V_\mathrm{REF} = V_\mathrm{BE1} + V_\mathrm{R4} + V_\mathrm{R3} + V_\mathrm{BE5}\).


**Fourth**, the feedback loop.


## Simulation

TODO: show the set up

![TL431](media/tl431c.png)

**DC Gain**



## Another schematic by Ken Shirriff

<https://www.righto.com/2014/05/reverse-engineering-tl431-most-common.html>

Note: the transistor and resistor numbers in the following schematic match Ken Shirriff's post, don't be confused.

![TL431](media/tl431ken.png)

> The resistances on the official schematic above are very different from what can be seen from the die.

Here's brief analysis of its DC operating point, ignoring base currents.

1. Assuming \(V_\mathrm{BE4}\approx V_\mathrm{BE6}\approx 0.65\mathrm{V}\)
1. Voltage drops on \(R_2\) and \(R_3\) are approx the same. \(R_2 = R_3\) and \(V_\mathrm{R2}\approx V_\mathrm{R3}\), so \(I_2\approx I_3\).
1. The area ratio of \(Q_4\) and \(Q_5\) is \(0.9:7.2\), so voltage on \(R_4\) is \(\Delta V_\mathrm{BE} = V_\mathrm{T}\ln \dfrac{7.2}{0.9}= V_\mathrm{T}\ln 8\approx 53.6\mathrm{mV}\) at room temperature.

1. Assuming for \(Q_5\), its \(I_\mathrm{C5} = I_\mathrm{E5} = I_3\), so voltage on \(R_3\) is \(\dfrac{24}{3.4}\Delta V_\mathrm{BE}\)

1. Voltage on \(R_1\) is \(I_1 R_1 = 2 I_3 R_1 = 2 \dfrac{R_1}{R_4}\Delta V_\mathrm{BE} =\dfrac{2\times 25}{3.4} \Delta V_\mathrm{BE}\).

1. In total, \(V_\mathrm{REF} = V_\mathrm{BE6} + V_\mathrm{R3} + V_\mathrm{R1} + V_\mathrm{BE2} = \dfrac{2\times 25 + 24}{3.4} \Delta V_\mathrm{BE} + V_\mathrm{BE6}  + V_\mathrm{BE2} = \dfrac{74}{3.4} \Delta V_\mathrm{BE} + 2V_\mathrm{BE} \)

1. The PTAT portion \(\dfrac{74}{3.4} \Delta V_\mathrm{BE} = 21.765\times\ln 8 V_\mathrm{T} \approx 45.26  V_\mathrm{T}\), which should be in right amount to cancel tempco of two \(V_\mathrm{BE}\).

1. Assuming \(R_1 + R_2/\!/R_3 = 5\mathrm{kΩ}\),
so that \(I_\mathrm{R1}\approx 240\)μA. With \(I_\mathrm{REF} = 2\)μA, we have \(\beta = 120\).
    * \((25+\dfrac{24}{2})R=5000\), \(R = 135Ω\)
    * \(R_1=3.38\mathrm{kΩ}\)
    * \(R_2=R_3=3.24\mathrm{kΩ}\)
    * \(R_4=460\mathrm{Ω}\)

## SPICE model by Eugene Dvoskin

<https://www.audio-perfection.com/voltage-regulators/linear-regulators/accurate-tl431-model-development-analysis-and-evaluation/>

TODO: show the set up

![TL431](media/tl431ed.png)

The Vref can be tuned to 2.495V by changing R4 to 3.22kΩ.

μA
kΩ
