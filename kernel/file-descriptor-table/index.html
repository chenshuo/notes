<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>File Descriptor Table - Shuo Chen's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shuo Chen's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../bugs/">Bugs</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../git/">Git</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Kernel <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../data-structures/">Data Structures</a>
</li>

                        
                            
<li class="active">
    <a href="./">File Descriptor Table</a>
</li>

                        
                            
<li >
    <a href="../epoll/">Epoll</a>
</li>

                        
                            
<li >
    <a href="../callgraph/">Call Graphs</a>
</li>

                        
                            
<li >
    <a href="../reuseport/">SO_REUSEPRT</a>
</li>

                        
                            
<li >
    <a href="../changes/">Changes</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../lcc/">lcc</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../lua/">Lua</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../mem/">mem</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../ssl/">SSL</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../links/">Links</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../data-structures/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../epoll/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#evolution-of-file-descriptor-table-in-linux-kernel">Evolution of File Descriptor Table in Linux Kernel</a></li>
        
            <li><a href="#001-to-1110">0.01 to 1.1.10</a></li>
        
            <li><a href="#1111-to-1321">1.1.11 to 1.3.21</a></li>
        
            <li><a href="#1322-to-2189">1.3.22 to 2.1.89</a></li>
        
            <li><a href="#2190-to-2613">2.1.90 to 2.6.13</a></li>
        
            <li><a href="#2614-to-now-4157">2.6.14 to now (4.15.7)</a></li>
        
    
        <li class="main "><a href="#freebsd-up-to-93">FreeBSD up to 9.3</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="evolution-of-file-descriptor-table-in-linux-kernel">Evolution of File Descriptor Table in Linux Kernel</h1>
<p><img alt="releases" src="../releases.png" /></p>
<h2 id="001-to-1110">0.01 to 1.1.10</h2>
<p>A fixed length array in <code>struct task_struct</code>.</p>
<pre><code class="c">// include/linux/sched.h of linux-1.1.10

struct task_struct {
        // ...
        struct file * filp[NR_OPEN];
        fd_set close_on_exec;
        // ...
};
</code></pre>

<p>Note 1: <code>file_table</code> and <code>inode_table</code> were made dynamic in 0.99.10.</p>
<table>
<thead>
<tr>
<th>Version</th>
<th><code>NR_OPEN</code></th>
<th><code>NR_FILE</code></th>
<th><code>NR_INODE</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>0.01</td>
<td>20</td>
<td>64</td>
<td>32</td>
</tr>
<tr>
<td>0.12</td>
<td>20</td>
<td>64</td>
<td>64</td>
</tr>
<tr>
<td>0.95</td>
<td>20</td>
<td>64</td>
<td>128</td>
</tr>
<tr>
<td>0.96a-patch3</td>
<td>32</td>
<td>64</td>
<td>128</td>
</tr>
<tr>
<td>0.96c-patch1</td>
<td>32</td>
<td>128</td>
<td>128</td>
</tr>
<tr>
<td>0.96pre</td>
<td>32</td>
<td>64</td>
<td>128</td>
</tr>
<tr>
<td>0.97</td>
<td>32</td>
<td>128</td>
<td>128</td>
</tr>
<tr>
<td>0.98.4</td>
<td>256</td>
<td>128</td>
<td>128</td>
</tr>
<tr>
<td>0.99.10</td>
<td>256</td>
<td>1024</td>
<td>2048</td>
</tr>
</tbody>
</table>
<pre><code class="diff">// fs/file_table.c of linux-0.99.10

-struct file file_table[NR_FILE];
+struct file * first_file;
</code></pre>

<p>Note 2: ext2 file system was added 0.99.7.</p>
<h2 id="1111-to-1321">1.1.11 to 1.3.21</h2>
<p>Split into <code>struct files_struct</code>.
1.1.11 was released in 1995/05.</p>
<pre><code class="c">// include/linux/sched.h of linux-1.3.21

struct files_struct {
        int count;
        fd_set close_on_exec;
        struct file * fd[NR_OPEN];
};

struct task_struct {
        // ...

/* filesystem information */
        struct fs_struct fs[1];
/* open file information */
        struct files_struct files[1];
/* memory management info */
        struct mm_struct mm[1];

        // ...

};
</code></pre>

<h2 id="1322-to-2189">1.3.22 to 2.1.89</h2>
<p>Change <code>files</code> from a <code>struct[1]</code> to a pointer, so it can be shared by threads within a process.
1.3.22 was released in 1995/09.  LinuxThreads needs 2.0 kernel, which was released in 1996/07.</p>
<pre><code class="diff">// include/linux/sched.h of linux-2.0.2

/* Open file table structure */
struct files_struct {
        int count;
        fd_set close_on_exec;
        fd_set open_fds;
        struct file * fd[NR_OPEN];
};

struct task_struct {
        // ...

 /* filesystem information */
-       struct fs_struct fs[1];
+       struct fs_struct *fs;
 /* open file information */
-       struct files_struct files[1];
+       struct files_struct *files;
 /* memory management info */
-       struct mm_struct mm[1];
+       struct mm_struct *mm;

        // ...
};
</code></pre>

<h2 id="2190-to-2613">2.1.90 to 2.6.13</h2>
<p>Change fixed-length array <code>fd</code> to dynamic array.
2.2.0 was released in 1999/01.</p>
<pre><code class="diff">// include/linux/sched.h of linux-2.2.0

/*
 * Open file table structure
 */
struct files_struct {
        atomic_t count;
+       int max_fds;
+       struct file ** fd;      /* current fd array */
        fd_set close_on_exec;   // changed to fd_set* in 2.2.12
        fd_set open_fds;
-       struct file * fd[NR_OPEN];
};

struct task_struct {
        // ...

/* open file information */
        struct files_struct *files;

        // ...

};
</code></pre>

<p><img alt="fdt" src="../fdt.png" /></p>
<h2 id="2614-to-now-4157">2.6.14 to now (4.15.7)</h2>
<p>Introduce <code>struct fdtable</code> for RCU. 2.6.15 was released in 2006/01, Ubuntu 6.04 LTS and Debian 4 ship it.</p>
<pre><code class="c">// include/linux/fdtable.h of linux-2.6.37

struct fdtable {
        unsigned int max_fds;
        struct file __rcu **fd;      /* current fd array */
        fd_set *close_on_exec;
        fd_set *open_fds;
        struct rcu_head rcu;
        struct fdtable *next;
};

/*
 * Open file table structure
 */
struct files_struct {
  /*
   * read mostly part
   */
        atomic_t count;
        struct fdtable __rcu *fdt;
        struct fdtable fdtab;
  /*
   * written part on a separate cache line in SMP
   */
        spinlock_t file_lock ____cacheline_aligned_in_smp;
        int next_fd;
        struct embedded_fd_set close_on_exec_init;
        struct embedded_fd_set open_fds_init;
        struct file __rcu * fd_array[NR_OPEN_DEFAULT];
};

struct task_struct {
        // ...

/* open file information */
        struct files_struct *files;

        // ...

};
</code></pre>

<p><code>struct file</code> itself.</p>
<pre><code class="c">// include/linux/fs.h of linux-4.9

struct file {
        union {
                struct llist_node       fu_llist;
                struct rcu_head         fu_rcuhead;
        } f_u;
        struct path             f_path;
        struct inode            *f_inode;  /* cached value */ // added back in 3.9, same as f_path.dentry-&gt;d_inode
        const struct file_operations    *f_op;

        /*
         * Protects f_ep_links, f_flags.
         * Must not be taken from IRQ context.
         */
        spinlock_t              f_lock;
        atomic_long_t           f_count;
        unsigned int            f_flags;
        fmode_t                 f_mode;
        struct mutex            f_pos_lock;  // Fixed in 3.14
        loff_t                  f_pos;
        struct fown_struct      f_owner;
        const struct cred       *f_cred;
        struct file_ra_state    f_ra;

        u64                     f_version;
#ifdef CONFIG_SECURITY
        void                    *f_security;
#endif
        /* needed for tty driver, and maybe others */
        void                    *private_data;

#ifdef CONFIG_EPOLL
        /* Used by fs/eventpoll.c to link all the hooks to this file */
        struct list_head        f_ep_links;
        struct list_head        f_tfile_llink;
#endif /* #ifdef CONFIG_EPOLL */
        struct address_space    *f_mapping;
} __attribute__((aligned(4)));  /* lest something weird decides that 2 is OK */
</code></pre>

<h1 id="freebsd-up-to-93">FreeBSD up to 9.3</h1>
<p><img alt="bsd" src="../bsd.png" /></p>
<p>4.3BSD-Reno and older BSDes use fixed-length array of <code>struct file*</code>.</p>
<pre><code>struct user {
        // ...
        struct  file *u_ofile[NOFILE];  /* file structures for open files */
        // ...
};
</code></pre>

<p>From BSD Net/2 up to FreeBSD 9.3 use a similiar dynamic array data structure of Linux 2.0 (see diagram above.),
where <code>proc</code> == <code>task_struct</code>, <code>filedesc</code> == <code>files_struct</code>, <code>file</code> == <code>file</code>.</p>
<pre><code class="c">// sys/proc.h
/*
 * Process structure.
 */
struct proc {
        // ...
        struct filedesc *p_fd;          /* (b) Open files. */
        // ...
};

// sys/filedesc.h
struct filedesc {
        struct  file **fd_ofiles;       /* file structures for open files */
        char    *fd_ofileflags;         /* per-process open file flags */
        struct  vnode *fd_cdir;         /* current directory */
        struct  vnode *fd_rdir;         /* root directory */
        struct  vnode *fd_jdir;         /* jail root directory */
        int     fd_nfiles;              /* number of open files allocated */
        NDSLOTTYPE *fd_map;             /* bitmap of free fds */
        int     fd_lastfile;            /* high-water mark of fd_ofiles */
        int     fd_freefile;            /* approx. next free file */
        u_short fd_cmask;               /* mask for file creation */
        u_short fd_refcnt;              /* thread reference count */
        u_short fd_holdcnt;             /* hold count on structure + mutex */
        struct  sx fd_sx;               /* protects members of this struct */
        struct  kqlist fd_kqlist;       /* list of kqueues on this filedesc */
        int     fd_holdleaderscount;    /* block fdfree() for shared close() */
        int     fd_holdleaderswakeup;   /* fdfree() needs wakeup */
};

// sys/file.h
struct file {
        void            *f_data;        /* file descriptor specific data */
        struct fileops  *f_ops;         /* File operations */
        struct ucred    *f_cred;        /* associated credentials. */
        struct vnode    *f_vnode;       /* NULL or applicable vnode */
        short           f_type;         /* descriptor type */
        short           f_vnread_flags; /* (f) Sleep lock for f_offset */
        volatile u_int  f_flag;         /* see fcntl.h */
        volatile u_int  f_count;        /* reference count */
        // ...
        off_t           f_offset;
        // ...
};
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
