<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>File Descriptor Table - Shuo Chen's Notes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "File Descriptor Table";
    var mkdocs_page_input_path = "kernel/file-descriptor-table.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-1220141-6', 'chenshuo.com');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Shuo Chen's Notes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../bugs/">Bugs</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Kernel</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../data-structures/">Data Structures</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">File Descriptor Table</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#001-to-1110">0.01 to 1.1.10</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1111-to-1321">1.1.11 to 1.3.21</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1322-to-2189">1.3.22 to 2.1.89</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2190-to-2613">2.1.90 to 2.6.13</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2614-to-now-4157">2.6.14 to now (4.15.7)</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../epoll/">Epoll</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../callgraph/">Call Graphs</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../reuseport/">SO_REUSEPRT</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../changes/">Changes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../links/">Links</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Languages</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../lcc/">lcc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../lua/">Lua</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../git/">Git</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../mem/">Memory Model</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../ssl/">SSL</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../dsp/">DSP</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../links/">Links</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Shuo Chen's Notes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Kernel &raquo;</li>
        
      
    
    <li>File Descriptor Table</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="evolution-of-file-descriptor-table-in-linux-kernel">Evolution of File Descriptor Table in Linux Kernel</h1>
<p><img alt="releases" src="../releases.png" /></p>
<h2 id="001-to-1110">0.01 to 1.1.10</h2>
<p>A fixed length array in <code>struct task_struct</code>.</p>
<pre><code class="c">// include/linux/sched.h of linux-1.1.10

struct task_struct {
        // ...
        struct file * filp[NR_OPEN];
        fd_set close_on_exec;
        // ...
};
</code></pre>

<p>Note 1: <code>file_table</code> and <code>inode_table</code> were made dynamic in 0.99.10.</p>
<table>
<thead>
<tr>
<th>Version</th>
<th><code>NR_OPEN</code></th>
<th><code>NR_FILE</code></th>
<th><code>NR_INODE</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>0.01</td>
<td>20</td>
<td>64</td>
<td>32</td>
</tr>
<tr>
<td>0.12</td>
<td>20</td>
<td>64</td>
<td>64</td>
</tr>
<tr>
<td>0.95</td>
<td>20</td>
<td>64</td>
<td>128</td>
</tr>
<tr>
<td>0.96a-patch3</td>
<td>32</td>
<td>64</td>
<td>128</td>
</tr>
<tr>
<td>0.96c-patch1</td>
<td>32</td>
<td>128</td>
<td>128</td>
</tr>
<tr>
<td>0.96pre</td>
<td>32</td>
<td>64</td>
<td>128</td>
</tr>
<tr>
<td>0.97</td>
<td>32</td>
<td>128</td>
<td>128</td>
</tr>
<tr>
<td>0.98.4</td>
<td>256</td>
<td>128</td>
<td>128</td>
</tr>
<tr>
<td>0.99.10</td>
<td>256</td>
<td>1024</td>
<td>2048</td>
</tr>
</tbody>
</table>
<pre><code class="diff">// fs/file_table.c of linux-0.99.10

-struct file file_table[NR_FILE];
+struct file * first_file;
</code></pre>

<p>Note 2: ext2 file system was added 0.99.7.</p>
<h2 id="1111-to-1321">1.1.11 to 1.3.21</h2>
<p>Split into <code>struct files_struct</code>.
1.1.11 was released in 1995/05.</p>
<pre><code class="c">// include/linux/sched.h of linux-1.3.21

struct files_struct {
        int count;
        fd_set close_on_exec;
        struct file * fd[NR_OPEN];
};

struct task_struct {
        // ...

/* filesystem information */
        struct fs_struct fs[1];
/* open file information */
        struct files_struct files[1];
/* memory management info */
        struct mm_struct mm[1];

        // ...

};
</code></pre>

<h2 id="1322-to-2189">1.3.22 to 2.1.89</h2>
<p>Change <code>files</code> from a <code>struct[1]</code> to a pointer, so it can be shared by threads within a process.
1.3.22 was released in 1995/09.  LinuxThreads needs 2.0 kernel, which was released in 1996/07.</p>
<pre><code class="diff">// include/linux/sched.h of linux-2.0.2

/* Open file table structure */
struct files_struct {
        int count;
        fd_set close_on_exec;
        fd_set open_fds;
        struct file * fd[NR_OPEN];
};

struct task_struct {
        // ...

 /* filesystem information */
-       struct fs_struct fs[1];
+       struct fs_struct *fs;
 /* open file information */
-       struct files_struct files[1];
+       struct files_struct *files;
 /* memory management info */
-       struct mm_struct mm[1];
+       struct mm_struct *mm;

        // ...
};
</code></pre>

<h2 id="2190-to-2613">2.1.90 to 2.6.13</h2>
<p>Change fixed-length array <code>fd</code> to dynamic array.
2.2.0 was released in 1999/01.</p>
<pre><code class="diff">// include/linux/sched.h of linux-2.2.0

/*
 * Open file table structure
 */
struct files_struct {
        atomic_t count;
+       int max_fds;
+       struct file ** fd;      /* current fd array */
        fd_set close_on_exec;   // changed to fd_set* in 2.2.12
        fd_set open_fds;
-       struct file * fd[NR_OPEN];
};

struct task_struct {
        // ...

/* open file information */
        struct files_struct *files;

        // ...

};
</code></pre>

<p><img alt="fdt" src="../fdt.png" /></p>
<h2 id="2614-to-now-4157">2.6.14 to now (4.15.7)</h2>
<p>Introduce <code>struct fdtable</code> for RCU. 2.6.15 was released in 2006/01, Ubuntu 6.04 LTS and Debian 4 ship it.</p>
<pre><code class="c">// include/linux/fdtable.h of linux-2.6.37

struct fdtable {
        unsigned int max_fds;
        struct file __rcu **fd;      /* current fd array */
        fd_set *close_on_exec;
        fd_set *open_fds;
        struct rcu_head rcu;
        struct fdtable *next;
};

/*
 * Open file table structure
 */
struct files_struct {
  /*
   * read mostly part
   */
        atomic_t count;
        struct fdtable __rcu *fdt;
        struct fdtable fdtab;
  /*
   * written part on a separate cache line in SMP
   */
        spinlock_t file_lock ____cacheline_aligned_in_smp;
        int next_fd;
        struct embedded_fd_set close_on_exec_init;
        struct embedded_fd_set open_fds_init;
        struct file __rcu * fd_array[NR_OPEN_DEFAULT];
};

struct task_struct {
        // ...

/* open file information */
        struct files_struct *files;

        // ...

};
</code></pre>

<p><code>struct file</code> itself.</p>
<pre><code class="c">// include/linux/fs.h of linux-4.9

struct file {
        union {
                struct llist_node       fu_llist;
                struct rcu_head         fu_rcuhead;
        } f_u;
        struct path             f_path;
        struct inode            *f_inode;  /* cached value */ // added back in 3.9, same as f_path.dentry-&gt;d_inode
        const struct file_operations    *f_op;

        /*
         * Protects f_ep_links, f_flags.
         * Must not be taken from IRQ context.
         */
        spinlock_t              f_lock;
        atomic_long_t           f_count;
        unsigned int            f_flags;
        fmode_t                 f_mode;
        struct mutex            f_pos_lock;  // Fixed in 3.14
        loff_t                  f_pos;
        struct fown_struct      f_owner;
        const struct cred       *f_cred;
        struct file_ra_state    f_ra;

        u64                     f_version;
#ifdef CONFIG_SECURITY
        void                    *f_security;
#endif
        /* needed for tty driver, and maybe others */
        void                    *private_data;

#ifdef CONFIG_EPOLL
        /* Used by fs/eventpoll.c to link all the hooks to this file */
        struct list_head        f_ep_links;
        struct list_head        f_tfile_llink;
#endif /* #ifdef CONFIG_EPOLL */
        struct address_space    *f_mapping;
} __attribute__((aligned(4)));  /* lest something weird decides that 2 is OK */
</code></pre>

<h1 id="freebsd-up-to-93">FreeBSD up to 9.3</h1>
<p><img alt="bsd" src="../bsd.png" /></p>
<p>4.3BSD-Reno and older BSDes use fixed-length array of <code>struct file*</code>.</p>
<pre><code>struct user {
        // ...
        struct  file *u_ofile[NOFILE];  /* file structures for open files */
        // ...
};
</code></pre>

<p>From BSD Net/2 up to FreeBSD 9.3 use a similiar dynamic array data structure of Linux 2.0 (see diagram above.),
where <code>proc</code> == <code>task_struct</code>, <code>filedesc</code> == <code>files_struct</code>, <code>file</code> == <code>file</code>.</p>
<pre><code class="c">// sys/proc.h
/*
 * Process structure.
 */
struct proc {
        // ...
        struct filedesc *p_fd;          /* (b) Open files. */
        // ...
};

// sys/filedesc.h
struct filedesc {
        struct  file **fd_ofiles;       /* file structures for open files */
        char    *fd_ofileflags;         /* per-process open file flags */
        struct  vnode *fd_cdir;         /* current directory */
        struct  vnode *fd_rdir;         /* root directory */
        struct  vnode *fd_jdir;         /* jail root directory */
        int     fd_nfiles;              /* number of open files allocated */
        NDSLOTTYPE *fd_map;             /* bitmap of free fds */
        int     fd_lastfile;            /* high-water mark of fd_ofiles */
        int     fd_freefile;            /* approx. next free file */
        u_short fd_cmask;               /* mask for file creation */
        u_short fd_refcnt;              /* thread reference count */
        u_short fd_holdcnt;             /* hold count on structure + mutex */
        struct  sx fd_sx;               /* protects members of this struct */
        struct  kqlist fd_kqlist;       /* list of kqueues on this filedesc */
        int     fd_holdleaderscount;    /* block fdfree() for shared close() */
        int     fd_holdleaderswakeup;   /* fdfree() needs wakeup */
};

// sys/file.h
struct file {
        void            *f_data;        /* file descriptor specific data */
        struct fileops  *f_ops;         /* File operations */
        struct ucred    *f_cred;        /* associated credentials. */
        struct vnode    *f_vnode;       /* NULL or applicable vnode */
        short           f_type;         /* descriptor type */
        short           f_vnread_flags; /* (f) Sleep lock for f_offset */
        volatile u_int  f_flag;         /* see fcntl.h */
        volatile u_int  f_count;        /* reference count */
        // ...
        off_t           f_offset;
        // ...
};
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../epoll/" class="btn btn-neutral float-right" title="Epoll">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../data-structures/" class="btn btn-neutral" title="Data Structures"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../data-structures/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../epoll/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
